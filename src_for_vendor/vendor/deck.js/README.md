# Custom Deck.js Stack

This directory contains a customised distribution of [deck.js](https://github.com/imakewebthings/deck.js) that powers the slide decks in this project.  It mixes upstream plugins with bespoke extensions that support rich animations, speaker tooling, and export workflows.  The notes below are aimed at developers who want to extend or maintain this fork.

## Layout At A Glance
- `deck.core.js` and `deck.core.css` - base runtime and visual defaults (includes local performance tweaks).
- `deck.fit.js` - keeps slides scaled to a design resolution (`designWidth`/`designHeight`) with different alignment modes.
- `deck.init.js` - presentation bootstrap: calls `$.deck`, wires custom slide actions, sets jsPlumb defaults, exposes `scaleDeck(baseHeight)`.
- `deck.events.js` - bridges deck navigation into per-slide jQuery events such as `deck.becameCurrent` / `deck.lostCurrent`.
- `deck.step.js` - redefines keyboard navigation to distinguish between nested and top-level slides; exposes helpers like `nextTopLevelSlide`.
- `deck.hash.js`, `deck.menu.js`, `deck.notes.js`, `deck.remote.js`, `deck.clone.js`, `deck.slide-clone.js`, `deck.velocity.js` - feature extensions described below.
- `deck.*.css` - companion styles for menu, hash/permalink, and notes panes.
- `deck.all.min.js`, `deck.all.min.css` - concatenated build outputs generated by `uglify_and_clean_css_deck.sh`.
- `uglify_and_clean_css_deck.sh` - local build script (uses `uglifyjs` and `cleancss`).

## Bootstrap And Global Behaviour
`deck.init.js` runs once the DOM is ready:
1. Initialises deck.js with `.slide` elements and fit options tuned for an 800x600 design canvas.  You can override these values when calling `$.deck` if a presentation needs a different base size.
2. Schedules any actions supplied via `window.deckSlideActions` (see **Slide Actions & Animations**) by deferring until the velocity plugin has registered its own actions.  If you add new action builders, ensure they call `$.deck('forceRefresh')` after registration so deep-linked loads pick them up.
3. Sets defaults for jsPlumb connectors (used by the `dv-connect` action).  Update these defaults here if you need different line styling across the deck.
4. Exposes `scaleDeck(baseHeight)` globally.  It mirrors the behaviour of the original `deck.scale` plugin but respects the custom fit configuration.

`deck.core.js` is close to upstream but includes two notable customisations:
- `removeOldSlideStates()` clears previous state classes via selectors instead of iterating the entire slide set, which improves performance on very large decks.
- `setAriaHiddens()` cooperates with nested slides so hidden fragments receive `aria-hidden="true"` unless they sit inside the active branch.

## Navigation Model
- `deck.step.js` overrides the default keyboard map.  The arrow keys step within nested stacks, while `up`/`down` jump between top-level slides.  Methods like `getToplevelSlideOf`, `nextTopLevelSlide`, and `previousTopLevelSlide` are available via `$.deck('extend', ...)` for custom controls.
- `deck.events.js` listens to `deck.change` and emits slide-scoped events (`deck.becameCurrent`, `deck.lostCurrent`, `deck.becamePrevious`, `deck.becameNext`).  These are useful when wiring behaviour directly to slide DOM nodes without doing manual index maths.

## Slide Actions & Animations (`deck.velocity.js`)
This module bundles two parts:
1. **`deck.slideActions`** - a small action registry layered on top of deck.js.  It provides `$.deck('addSlideAction', index, action)` and ensures actions fire when the deck appears mid-way through navigation (e.g. via hash links).  Actions support optional `doit`, `undoit`, and `doAfter` callbacks.
2. **`deck.velocity`** - parses special `.dv` helper elements that are emitted by the slide authoring pipeline.  Each helper maps to an action:
   - `dv-velocity`: run a Velocity animation with undo support.
   - `dv-style`: apply raw CSS and restore original values when exiting.
   - `dv-addclass` / `dv-removeclass`: manage classes (with wildcard removal support).
   - `dv-attr`: set/restore element attributes.
   - `dv-connect`: draw jsPlumb connectors between elements (temporarily disables scaling during wiring to avoid layout drift).

If you define new action types, add a key to the `elements_to_actions` map.  Each handler receives the helper element and a parsed context (targets, CSS payloads, options).  Remember to register an `undoit` function whenever forward navigation mutates state, because the action system replays `undoit` while scrubbing backwards.

Dependencies: Velocity.js must be loaded, and jsPlumb is optional unless you use `dv-connect`.

## Notes, Handouts, And Exports (`deck.notes.js`)
- Toggle the live notes pane with `n`; hold `Shift`+`n` for the export view; `Alt`+`n` toggles a wider layout for readability.  Press `h` to show the handout export panel.
- The module expects two containers upstream of `.deck-container`:
  ```html
  <section class="deck-notes"><div class="deck-notes-container"></div></section>
  <section class="deck-handout"><div class="deck-handout-container"></div></section>
  ```
- Slide authors add `.notes`, `.handout`, or `.transcript` blocks inside slides.  Elements with `.show` remain visible on the slide; others are stripped from the live deck and replicated into the notes/handout panes.
- Notes are grouped by slide id.  When exporting, the script emits LaTeX-friendly markup (e.g. escapes `&`, maps logic symbols, appends `\subsection{...}` headers).  Handouts similarly convert embedded images to `\includegraphics` snippets and append exercise material if `.exercises` or `.exercises_fast` elements exist.
- On `deck.change` the correct subset of notes is revealed, so the notes pane stays synchronised with navigation.

Any refactor must keep the DOM traversal in sync with the markup conventions above, otherwise the export pipeline will break.

## Menu, Hash, Remote, And Cloning Extensions
- `deck.menu.js` - standard thumbnail overview (key `m`) with minor custom styling.  Slides are scaled via transforms when CSS transforms are available.
- `deck.hash.js` - deep-link support and `on-slide-<id>` body classes.  Works alongside `deck.core`'s hash handling.
- `deck.remote.js` - lazy-initialises the third-party remote controller.  Appends `?master` or `?client` to auto-connect, or press `Shift+Alt+r` to start it manually.  Update the `server`/`port` values here if your remote backend changes.
- `deck.clone.js` - opens mirrored presentation windows (key `c`) and syncs navigation plus a "laser pointer" marker (`.clonepointer`).  Useful for presenter displays.
- `deck.slide-clone.js` - clones slide fragments into the current slide the first time it becomes active.  Because it manipulates `.slide` descendants, it can behave unpredictably in complex nesting; heed the warning in the module before relying on it.

## Styling Notes
- `deck.core.css` resets layout, ensures the deck container fills the viewport, hides inactive slides, and prevents scroll bleed during transitions.  It also preserves nested slide visibility rules that the JS relies on (`.deck-child-current`).
- `deck.menu.css` scales slides inside the menu view and dims the backdrop.
- `deck.notes.css` styles the notes and handout side panels, hiding `.notes/.handout/.transcript` blocks unless explicitly marked `.show`.
- `deck.hash.css` contains the permalink affordance (hidden by default while History API is available).

When adjusting layout, check both the live deck and export panels; many selectors are shared.

## Build And Distribution
The source files are used only as part of the parent directory:

```sh
../uglify_and_cleancss.sh
```

You will need `uglifyjs` (`npm install -g uglify-js`) and `cleancss` (`npm install -g clean-css-cli`).  The script concatenates the JS modules in a specific order; keep that order in mind if you add new extensions.

Confusingly there is also `./uglify_and_clean_css_deck.sh`; I am not sure what this is for.

## Extending This Fork
1. Follow the existing plugin pattern: expose new APIs with `$.deck('extend', ...)`, listen to `deck.init`/`deck.change`, and avoid global state unless you need to coordinate with non-plugin code.
2. Reuse existing helpers: `$.deck('getOptions')`, `$.deck('forceRefresh')`, and the slide action registry prevent subtle sync bugs.
3. Keep undo paths in mind.  Anything that mutates the DOM during forward navigation should register a reverse operation so that keyboard backtracking leaves slides clean.
4. Update the notes/handout processors if you introduce new markup classes in the slides; otherwise exports will miss the new content or break LaTeX output.
5. Re-run the bundling script and smoke-test:
   - Load a deck and check navigation, scaling, and menu.
   - Exercise the notes pane and export modifiers.
   - Try a few `.dv-*` animations forward and backward.
   - Verify hash deep-links and top-level navigation shortcuts.

The runtime is deliberately jQuery-centric to match deck.js conventions.  If you modernise portions (e.g. migrating to ES modules), document the loading order and update `deck.all.min.js` accordingly.
